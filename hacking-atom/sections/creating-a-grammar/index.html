<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
<title>Creating a Grammar</title>

<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" media="all" href="/assets/stylesheets/application.css" data-proofer-ignore>


<script type="text/javascript" src="/assets/javascripts/application.js"></script>

<script type="text/javascript">
  $(function() {
    $('#quicksearch-query').lunrSearch({

      indexUrl: '/search.json',

      quickSearchResults:  '.autocomplete-results',
      quickSearchEntries:  '.result-group',
      quickSearchTemplate: '#quicksearch-results-template',

      searchResults: '.search-container',
      searchEntries: '.search-results',
      searchTemplate: '#search-results-template'
    })
  })
</script>

  </head>
  <body class="layout-article">
    <div class="footer-push">
      <div class="top-bar">
  <div class="wrapper no-pad">

    <ul class="navigation">
      <li><h1 title="Atom: A hackable text editor for the 21st Century"><a href="https://atom.io/" class="logo-small"></a></h1></li>
      <li><a href="https://atom.io/packages">Packages</a></li>
      <li><a href="https://atom.io/themes">Themes</a></li>
      <li><a href="https://atom.io/docs" class="is-selected">Documentation</a></li>
      <li><a href="https://blog.atom.io">Blog</a></li>
      <li><a href="https://discuss.atom.io">Discuss</a></li>
    </ul>

  </div>
</div>

      <div class="wrapper documents content-push wide">
        <script id="quicksearch-results-template" type="text/mustache">
  [[#entries]]
    <a href="[[url]]" class="js-articles-quicksearch-link">[[title]]</a>
  [[/entries]]
  <a class="initial quicksearch-seemore" href="/search?q=">See more results</a>
</script>

<script id="search-results-template" type="text/mustache">
  [[#entries]]
    <li>
      <h3>
        <a href="[[url]]">[[title]]</a>
        <div class="label"><a href="[[category_url]]">[[category]]</a></div>
      </h3>
      <p>
      [[excerpt]]
      </p>
    </li>
  [[/entries]]
</script>

<div class="documents-search">
  <form accept-charset="UTF-8" action="/search" id="articles-search" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="✓"></div>
    <input type="search" name="q" id="quicksearch-query" class="documents-search-input js-articles-quicksearch" placeholder="Search the Flight Manual" autocomplete="off">
  </form>
</div>

<div class="autocomplete-results" style="display: none;">
  <div class="result-group"></div>
</div>


        <div class="toc">
          


  <h4>
    <a href="/getting-started">Chapter 1: Getting Started</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/getting-started/sections/why-atom">Why Atom?</a>
      </li>
    
      <li class="unselected">
        <a href="/getting-started/sections/installing-atom">Installing Atom</a>
      </li>
    
      <li class="unselected">
        <a href="/getting-started/sections/atom-basics">Atom Basics</a>
      </li>
    
      <li class="unselected">
        <a href="/getting-started/sections/summary">Summary</a>
      </li>
    
  </ul>

  <h4>
    <a href="/using-atom">Chapter 2: Using Atom</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/using-atom/sections/atom-packages">Atom Packages</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/moving-in-atom">Moving in Atom</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/atom-selections">Atom Selections</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/editing-and-deleting-text">Editing and Deleting Text</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/find-and-replace">Find and Replace</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/snippets">Snippets</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/autocomplete">Autocomplete</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/folding">Folding</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/panes">Panes</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/pending-pane-items">Pending Pane Items</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/grammar">Grammar</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/version-control-in-atom">Version Control in Atom</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/github-package">GitHub package</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/writing-in-atom">Writing in Atom</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/basic-customization">Basic Customization</a>
      </li>
    
      <li class="unselected">
        <a href="/using-atom/sections/summary">Summary</a>
      </li>
    
  </ul>

  <h4>
    <a href="/hacking-atom">Chapter 3: Hacking Atom</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/tools-of-the-trade">Tools of the Trade</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/the-init-file">The Init File</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/package-word-count">Package: Word Count</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/package-modifying-text">Package: Modifying Text</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/package-active-editor-info">Package: Active Editor Info</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/creating-a-theme">Creating a Theme</a>
      </li>
    
      <li class="selected">
        <a href="/hacking-atom/sections/creating-a-grammar">Creating a Grammar</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/creating-a-legacy-textmate-grammar">Creating a Legacy TextMate Grammar</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/publishing">Publishing</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/iconography">Iconography</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/debugging">Debugging</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/writing-specs">Writing specs</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/handling-uris">Handling URIs</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/cross-platform-compatibility">Cross-Platform Compatibility</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/converting-from-textmate">Converting from TextMate</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/hacking-on-atom-core">Hacking on Atom Core</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/contributing-to-official-atom-packages">Contributing to Official Atom Packages</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/creating-a-fork-of-a-core-package-in-atom-atom">Creating a Fork of a Core Package in atom/atom</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/maintaining-a-fork-of-a-core-package-in-atom-atom">Maintaining a Fork of a Core Package in atom/atom</a>
      </li>
    
      <li class="unselected">
        <a href="/hacking-atom/sections/summary">Summary</a>
      </li>
    
  </ul>

  <h4>
    <a href="/behind-atom">Chapter 4: Behind Atom</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/behind-atom/sections/configuration-api">Configuration API</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/keymaps-in-depth">Keymaps In-Depth</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/scoped-settings-scopes-and-scope-descriptors">Scoped Settings, Scopes and Scope Descriptors</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/serialization-in-atom">Serialization in Atom</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/developing-node-modules">Developing Node Modules</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/interacting-with-other-packages-via-services">Interacting With Other Packages Via Services</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/maintaining-your-packages">Maintaining Your Packages</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/how-atom-uses-chromium-snapshots">How Atom Uses Chromium Snapshots</a>
      </li>
    
      <li class="unselected">
        <a href="/behind-atom/sections/summary">Summary</a>
      </li>
    
  </ul>



  <h4>
    <a href="/resources">Appendix A: Resources</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/resources/sections/glossary">Glossary</a>
      </li>
    
  </ul>

  <h4>
    <a href="/shadow-dom">Appendix B: Shadow DOM</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/shadow-dom/sections/removing-shadow-dom-styles">Removing Shadow DOM styles</a>
      </li>
    
  </ul>

  <h4>
    <a href="/upgrading-to-1-0-apis">Appendix C: Upgrading to 1.0 APIs</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/upgrading-to-1-0-apis/sections/upgrading-your-package">Upgrading Your Package</a>
      </li>
    
      <li class="unselected">
        <a href="/upgrading-to-1-0-apis/sections/upgrading-your-ui-theme-or-package-selectors">Upgrading Your UI Theme Or Package Selectors</a>
      </li>
    
      <li class="unselected">
        <a href="/upgrading-to-1-0-apis/sections/upgrading-your-syntax-theme">Upgrading Your Syntax Theme</a>
      </li>
    
  </ul>

  <h4>
    <a href="/atom-server-side-apis">Appendix D: Atom server-side APIs</a>
  </h4>
  <ul>
    
      <li class="unselected">
        <a href="/atom-server-side-apis/sections/atom-package-server-api">Atom package server API</a>
      </li>
    
      <li class="unselected">
        <a href="/atom-server-side-apis/sections/atom-update-server-api">Atom update server API</a>
      </li>
    
  </ul>


        </div>

        
        <h1 class="document-title">
          <div id="platform-nav">
  <span class="octicon octicon-device-desktop"></span>
  <ul>
    <li class="platform-mac">
      <a href="#platform-mac" data-platform="mac">
        mac
      </a>
    </li>
    <li class="platform-windows">
      <a href="#platform-windows" data-platform="windows">
        windows
      </a>
    </li>
    <li class="platform-linux">
      <a href="#platform-linux" data-platform="linux">
        linux
      </a>
    </li>
  </ul>
</div>

          <a class="improve-link"
              href="https://github.com/atom/flight-manual.atom.io/edit/master/content/hacking-atom/sections/creating-a-grammar.md" data-proofer-ignore>
            <span class="octicon octicon-pencil"></span> Improve this page
          </a>
        </h1>

        <div class="markdown-body document-content">
          
          <h3>
<a id="creating-a-grammar" class="anchor" href="#creating-a-grammar" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a Grammar</h3>

<p>Atom's syntax highlighting and code folding system is powered by <a href="http://tree-sitter.github.io/tree-sitter">Tree-sitter</a>. Tree-sitter parsers create and maintain full <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree"><em>syntax trees</em></a> representing your code.</p>

<p>This syntax tree gives Atom a comprehensive understanding of the structure of your code, which has several benefits:</p>

<ol>
<li>Syntax highlighting will not break because of formatting changes.</li>
<li>Code folding will work regardless of how your code is indented.</li>
<li>Editor features can operate on the syntax tree. For instance, the <code>Select Larger Syntax Node</code> and <code>Select Smaller Syntax Node</code> allow you to select conceptually larger and smaller chunks of your code.</li>
<li>Community packages can use the syntax tree to manipulate code intelligently.</li>
</ol>

<p>Tree-sitter grammars are relatively new. Many languages in Atom are still supported by <a href="../creating-a-legacy-textmate-grammar">TextMate grammars</a>, though we intend to phase these out over time.</p>

<p>If you're adding support for a new language, you're in the right place!</p>

<h4>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting Started</h4>

<p>There are two components required to use Tree-sitter in Atom: a <em>parser</em> and a <em>grammar</em> file.</p>

<h4>
<a id="the-parser" class="anchor" href="#the-parser" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Parser</h4>

<p>Tree-sitter generates parsers based on <a href="https://en.wikipedia.org/wiki/Context-free_grammar">context-free grammars</a> that are typically written in JavaScript. The generated parsers are C libraries that can be used in other applications as well as Atom.</p>

<p>They can also be developed and tested at the command line, separately from Atom. Tree-sitter has <a href="http://tree-sitter.github.io/tree-sitter/creating-parsers">its own documentation page</a> on how to create these parsers. The <a href="https://github.com/tree-sitter">Tree-sitter GitHub organization</a> also contains a lot of example parsers that you can learn from, each in its own repository.</p>

<p>Once you have created a parser, you need to publish it to <a href="https://npmjs.com">the NPM registry</a> to use it in Atom. To do this, make sure you have a <code>name</code> and <code>version</code> in your parser's <code>package.json</code>:</p>

<div class="highlight highlight-js"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"tree-sitter-mylanguage"</span><span class="p">,</span>
  <span class="s2">"version"</span><span class="p">:</span> <span class="s2">"0.0.1"</span><span class="p">,</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p>then run the command <code>npm publish</code>.</p>

<h4>
<a id="the-package" class="anchor" href="#the-package" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Package</h4>

<p>Once you have a Tree-sitter parser that is available on npm, you can use it in your Atom package. Packages with grammars are, by convention, always named starting with <em>language</em>. You'll need a folder with a <code>package.json</code>, a <code>grammars</code> subdirectory, and a single <code>json</code> or <code>cson</code> file in the <code>grammars</code> directory, which can be named anything.</p>

<pre><code>language-mylanguage
├── LICENSE
├── README.md
├── grammars
│   └── mylanguage.cson
└── package.json
</code></pre>

<h4>
<a id="the-grammar-file" class="anchor" href="#the-grammar-file" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Grammar File</h4>

<p>The <code>mylanguage.cson</code> file specifies how Atom should use the parser you created.</p>

<h4>
<a id="basic-fields" class="anchor" href="#basic-fields" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic Fields</h4>

<p>It starts with some required fields:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">name</span><span class="o">:</span> <span class="s">'My Language'</span>
<span class="na">scopeName</span><span class="o">:</span> <span class="s">'mylanguage'</span>
<span class="na">type</span><span class="o">:</span> <span class="s">'tree-sitter'</span>
<span class="na">parser</span><span class="o">:</span> <span class="s">'tree-sitter-mylanguage'</span>
</code></pre></div>

<ul>
<li>
<code>scopeName</code> - A unique, stable identifier for the language. Atom users will use this in configuration files if they want to specify custom configuration based on the language.</li>
<li>
<code>name</code> - A human readable name for the language.</li>
<li>
<code>parser</code> - The name of the parser node module that will be used for parsing. This string will be passed directly to <a href="https://nodejs.org/api/modules.html#modules_require"><code>require()</code></a> in order to load the parser.</li>
<li>
<code>type</code> - This should have the value <code>tree-sitter</code> to indicate to Atom that this is a Tree-sitter grammar and not a <a href="../creating-a-legacy-textmate-grammar">TextMate grammar</a>.</li>
</ul>

<h4>
<a id="language-recognition" class="anchor" href="#language-recognition" aria-hidden="true"><span class="octicon octicon-link"></span></a>Language Recognition</h4>

<p>Next, the file should contain some fields that indicate to Atom <em>when</em> this language should be used. These fields are all optional.</p>

<ul>
<li>
<code>fileTypes</code> - An array of filename <em>suffixes</em>. The grammar will be used for files whose names end with one of these suffixes. Note that the suffix may be an entire filename.</li>
<li>
<code>firstLineRegex</code> - A regex pattern that will be tested against the first line of the file. The grammar will be used if this regex matches.</li>
<li>
<code>contentRegex</code> - A regex pattern that will be tested against the contents of the file in order to break ties in cases where <em>multiple</em> grammars matched the file using the above two criteria. If the <code>contentRegex</code> matches, this grammar will be preferred over another grammar with no <code>contentRegex</code>. If the <code>contentRegex</code> does <em>not</em> match, a grammar with no <code>contentRegex</code> will be preferred over this one.</li>
</ul>

<h4>
<a id="syntax-highlighting" class="anchor" href="#syntax-highlighting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Syntax Highlighting</h4>

<p>The HTML classes that Atom uses for syntax highlighting do not correspond directly to nodes in the syntax tree. Instead, Tree-sitter grammar files specify <em>scope mappings</em> that specify which classes should be applied to which syntax nodes. The <code>scopes</code> object controls these scope mappings. Its keys are CSS selectors that select nodes in the syntax tree. Its values can be of several different types.</p>

<p>Here is a simple example:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">scopes</span><span class="o">:</span>
  <span class="s">'call_expression &gt; identifier'</span><span class="o">:</span> <span class="s">'entity.name.function'</span>
</code></pre></div>

<p>This entry means that, in the syntax tree, any <code>identifier</code> node whose parent is a <code>call_expression</code> should be highlighted using three classes: <code>syntax--entity</code>, <code>syntax--name</code>, and <code>syntax--function</code>.</p>

<p>Note that in this selector, we're using the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Child_selectors">immediate child combinator</a> (<code>&gt;</code>). Arbitrary descendant selectors without this combinator (for example <code>'call_expression identifier'</code>, which would match any <code>identifier</code> occurring anywhere within a <code>call_expression</code>) are currently not supported.</p>

<h5>
<a id="advanced-selectors" class="anchor" href="#advanced-selectors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Advanced Selectors</h5>

<p>The keys of the <code>scopes</code> object can also contain <em>multiple</em> CSS selectors, separated by commas, similar to CSS files. The triple-quote syntax in CSON makes it convenient to write keys like this on multiple lines:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">scopes</span><span class="o">:</span>
  <span class="s">'''
  function_declaration &gt; identifier,
  call_expression &gt; identifier,
  call_expression &gt; field_expression &gt; field_identifier
  '''</span><span class="o">:</span> <span class="s">'entity.name.function'</span>
</code></pre></div>

<p>You can use the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/:nth-child"><code>:nth-child</code> pseudo-class</a> to select nodes based on their order within their parent. For example, this example selects <code>identifier</code> nodes which are the fourth (zero-indexed) child of a <code>singleton_method</code> node.</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">scopes</span><span class="o">:</span>
  <span class="s">'singleton_method &gt; identifier:nth-child(3)'</span><span class="o">:</span> <span class="s">'entity.name.function'</span>
</code></pre></div>

<p>Finally, you can use double-quoted strings in the selectors to select <em>anonymous</em> tokens in the syntax tree, like <code>(</code> and <code>:</code>. See <a href="http://tree-sitter.github.io/tree-sitter/using-parsers#named-vs-anonymous-nodes">the Tree-sitter documentation</a> for more information about named vs anonymous tokens.</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">scopes</span><span class="o">:</span>
  <span class="s">'''
    "*",
    "/",
    "+",
    "-"
  '''</span><span class="o">:</span> <span class="s">'keyword.operator'</span>
</code></pre></div>

<h5>
<a id="text-based-mappings" class="anchor" href="#text-based-mappings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Text-based Mappings</h5>

<p>You can also apply different classes to a syntax node based on its text. Here are some examples:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">scopes</span><span class="o">:</span>

  <span class="c1"># Apply the classes `syntax--builtin` and `syntax--variable` to all</span>
  <span class="c1"># `identifier` nodes whose text is `require`.</span>
  <span class="s">'identifier'</span><span class="o">:</span> <span class="p">{</span><span class="na">exact</span><span class="o">:</span> <span class="s">'require'</span><span class="p">,</span> <span class="na">scopes</span><span class="o">:</span> <span class="s">'builtin.variable'</span><span class="p">},</span>

  <span class="c1"># Apply the classes `syntax--type` and `syntax--integer` to all</span>
  <span class="c1"># `primitive_type` nodes whose text starts with `int` or `uint`.</span>
  <span class="s">'primitive_type'</span><span class="o">:</span> <span class="p">{</span><span class="na">match</span><span class="o">:</span> <span class="sr">/^u?int/</span><span class="p">,</span> <span class="na">scopes</span><span class="o">:</span> <span class="s">'type.integer'</span><span class="p">},</span>

  <span class="c1"># Apply the classes `syntax--builtin`, `syntax--class`, and</span>
  <span class="c1"># `syntax--name` to `constant` nodes with the text `Array`,</span>
  <span class="c1"># `Hash` and `String`. For all other `constant` nodes, just</span>
  <span class="c1"># apply the classes `syntax--class` and `syntax--name`.</span>
  <span class="s">'constant'</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="na">match</span><span class="o">:</span> <span class="sr">/^(Array|Hash|String)$/</span><span class="p">,</span> <span class="na">scopes</span><span class="o">:</span> <span class="s">'builtin.class.name'</span><span class="p">},</span>
    <span class="s">'class.name'</span>
  <span class="p">]</span>
</code></pre></div>

<p>In total there are four types of values that can be associated with selectors in <code>scopes</code>:</p>

<ul>
<li>Strings - Each class name in the dot-separated string will be prefixed with <code>syntax--</code> and applied to the selected node.</li>
<li>Objects with the keys <code>exact</code> and <code>scopes</code> - If the node's text equals the <code>exact</code> string, the <code>scopes</code> string will be used as described above.</li>
<li>Objects with the keys <code>match</code> and <code>scopes</code> - If the node's text matches the <code>match</code> regex pattern, the <code>scopes</code> string will be used as described above.</li>
<li>Arrays - The elements of the array will be processed from beginning to end. The first element that matches the selected node will be used as describe above.</li>
</ul>

<h5>
<a id="specificity" class="anchor" href="#specificity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Specificity</h5>

<p>If multiple selectors in the <code>scopes</code> object match a node, the node's classes will be decided based on the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity">most specific</a> selector. Note that the <code>exact</code> and <code>match</code> rules do <em>not</em> affect specificity, so you may need to supply the same <code>exact</code> or <code>match</code> rules for multiple selectors to ensure that they take precedence over other selectors. You can use the same selector multiple times in a scope mapping, within different comma-separated keys:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">scopes</span><span class="o">:</span>
  <span class="s">'call_expression &gt; identifier'</span><span class="o">:</span> <span class="s">'entity.name.function'</span>

  <span class="c1"># If we did not include the second selector here, then this rule</span>
  <span class="c1"># would not apply to identifiers inside of call_expressions,</span>
  <span class="c1"># because the selector `call_expression &gt; identifier` is more</span>
  <span class="c1"># specific than the selector `identifier`.</span>
  <span class="s">'identifier, call_expression &gt; identifier'</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="na">exact</span><span class="o">:</span> <span class="s">'require'</span><span class="p">,</span> <span class="na">scopes</span><span class="o">:</span> <span class="s">'builtin.variable'</span><span class="p">},</span>
    <span class="p">{</span><span class="na">match</span><span class="o">:</span> <span class="sr">/^[A-Z]/</span><span class="p">,</span> <span class="na">scopes</span><span class="o">:</span> <span class="s">'constructor'</span><span class="p">},</span>
  <span class="p">]</span>
</code></pre></div>

<h4>
<a id="language-injection" class="anchor" href="#language-injection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Language Injection</h4>

<p>Sometimes, a source file can contain code written in several different languages. Tree-sitter grammars support this situation using a two-part process called <em>language injection</em>. First, an 'outer' language must define an <em>injection point</em> - a set of syntax nodes whose text can be parsed using a different language, along with some logic for guessing the <em>name</em> of the other language that should be used. Second, an 'inner' language must define an <code>injectionRegex</code> - a regex pattern that will be tested against the language name provided by the injection point.</p>

<p>For example, in JavaScript, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#Tagged_templates">tagged template literals</a> sometimes contain code written in a different language, and the name of the language is often used in the 'tag' function, as shown in this example:</p>

<div class="highlight highlight-js"><pre class="highlight"><code><span class="c1">// HTML in a template literal</span>
<span class="kd">const</span> <span class="nx">htmlContent</span> <span class="o">=</span> <span class="nx">html</span> <span class="s2">`&lt;div&gt;Hello </span><span class="p">${</span><span class="nx">name</span><span class="p">}</span><span class="s2">&lt;/div&gt;`</span>
</code></pre></div>

<p>The <code>tree-sitter-javascript</code> parser parses this tagged template literal as a <code>call_expression</code> with two children: an <code>identifier</code> and a <code>template_literal</code>:</p>

<pre><code>(call_expression
  (identifier)
  (template_literal
    (interpolation
      (identifier))))
</code></pre>

<p>Here is an injection point that would allow syntax highlighting inside of template literals:</p>

<div class="highlight highlight-js"><pre class="highlight"><code><span class="nx">atom</span><span class="p">.</span><span class="nx">grammars</span><span class="p">.</span><span class="nx">addInjectionPoint</span><span class="p">(</span><span class="s1">'source.js'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">type</span><span class="p">:</span> <span class="s1">'call_expression'</span><span class="p">,</span>

  <span class="nx">language</span> <span class="p">(</span><span class="nx">callExpression</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span><span class="nx">firstChild</span><span class="p">}</span> <span class="o">=</span> <span class="nx">callExpression</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'identifier'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">firstChild</span><span class="p">.</span><span class="nx">text</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">content</span> <span class="p">(</span><span class="nx">callExpression</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span><span class="nx">lastChild</span><span class="p">}</span> <span class="o">=</span> <span class="nx">callExpression</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lastChild</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'template_string'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">lastChild</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div>

<p>The <code>language</code> callback would then be called with every <code>call_expression</code> node in the syntax tree. In the example above, it would retrieve the first child of the <code>call_expression</code>, which is an <code>identifier</code> with the name "html". The callback would then return the string "html".</p>

<p>The <code>content</code> callback would then be called with the same <code>call_expression</code> node and return the  <code>template_string</code> node within the <code>call_expression</code> node.</p>

<p>In order to parse the HTML within the template string, the HTML grammar file would need to specify an <code>injectionRegex</code>:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">injectionRegex</span><span class="o">:</span> <span class="s">'html|HTML'</span>
</code></pre></div>

<h4>
<a id="code-folding" class="anchor" href="#code-folding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code Folding</h4>

<p>The next field in the grammar file, <code>folds</code>, controls code folding. Its value is an array of <em>fold pattern</em> objects. Fold patterns are used to decide whether or not a syntax node can be folded, and if so, where the fold should start and end. Here are some example fold patterns:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">folds</span><span class="o">:</span> <span class="p">[</span>

  <span class="c1"># All `comment` nodes are foldable. By default, the fold starts at</span>
  <span class="c1"># the end of the node's first line, and ends at the beginning</span>
  <span class="c1"># of the node's last line.</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="o">:</span> <span class="s">'comment'</span>
  <span class="p">}</span>

  <span class="c1"># `if_statement` nodes are foldable if they contain an anonymous</span>
  <span class="c1"># "then" token and either an `elif_clause` or `else_clause` node.</span>
  <span class="c1"># The fold starts at the end of the "then" token and ends at the</span>
  <span class="c1"># `elif_clause` or `else_clause`.</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="o">:</span> <span class="s">'if_statement'</span><span class="p">,</span>
    <span class="na">start</span><span class="o">:</span> <span class="p">{</span><span class="na">type</span><span class="o">:</span> <span class="s">'"then"'</span><span class="p">}</span>
    <span class="na">end</span><span class="o">:</span> <span class="p">{</span><span class="na">type</span><span class="o">:</span> <span class="p">[</span><span class="s">'elif_clause'</span><span class="p">,</span> <span class="s">'else_clause'</span><span class="p">]}</span>
  <span class="p">}</span>

  <span class="c1"># Any node that starts with an anonymous "(" token and ends with</span>
  <span class="c1"># an anonymous ")" token is foldable. The fold starts after the</span>
  <span class="c1"># "(" and ends before the ")".</span>
  <span class="p">{</span>
    <span class="na">start</span><span class="o">:</span> <span class="p">{</span><span class="na">type</span><span class="o">:</span> <span class="s">'"("'</span><span class="p">,</span> <span class="na">index</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span>
    <span class="na">end</span><span class="o">:</span> <span class="p">{</span><span class="na">type</span><span class="o">:</span> <span class="s">'")"'</span><span class="p">,</span> <span class="na">index</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p>Fold patterns can have one or more of the following fields:</p>

<ul>
<li>
<code>type</code> - A string or array of strings. In order to be foldable according to this pattern, a syntax node's type must match one of these strings.</li>
<li>
<code>start</code> - An object that is used to identify a <em>child</em> node after which the fold should start. The object can have one or both of the following fields:

<ul>
<li>
<code>type</code> - A string or array of strings. To start a fold, a child node's type must match one of these strings.</li>
<li>
<code>index</code> - a number that's used to select a specific child according to its index. Negative values are interpreted as indices relative the last child, so that <code>-1</code> means the last child.</li>
</ul>
</li>
<li>
<code>end</code> - An object that is used to identify a <em>child</em> node before which the fold should end. It has the same structure as the <code>start</code> object.</li>
</ul>

<h4>
<a id="comments" class="anchor" href="#comments" aria-hidden="true"><span class="octicon octicon-link"></span></a>Comments</h4>

<p>The last field in the grammar file, <code>comments</code>, controls the behavior of Atom's <code>Editor: Toggle Line Comments</code> command. Its value is an object with a <code>start</code> field and an optional <code>end</code> field. The start field is a string that should be prepended to or removed from lines in order to comment or un-comment them.</p>

<p>In JavaScript, it looks like this:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">comments</span><span class="o">:</span>
  <span class="na">start</span><span class="o">:</span> <span class="s">'// '</span>
</code></pre></div>

<p>The <code>end</code> field should be used for languages that only support block comments, not line comments. If present, it will be appended to or removed from the end of the last selected line in order to comment or un-comment the selection.</p>

<p>In CSS, it would look like this:</p>

<div class="highlight highlight-coffee"><pre class="highlight"><code><span class="na">comments</span><span class="o">:</span>
  <span class="na">start</span><span class="o">:</span> <span class="s">'/* '</span>
  <span class="na">end</span><span class="o">:</span> <span class="s">' */'</span>
</code></pre></div>

<h4>
<a id="example-packages" class="anchor" href="#example-packages" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example Packages</h4>

<p>More examples of all of these features can be found in the Tree-sitter grammars bundled with Atom:</p>

<ul>
<li><a href="https://github.com/atom/language-shellscript">Bash</a></li>
<li><a href="https://github.com/atom/language-c">C</a></li>
<li><a href="https://github.com/atom/language-go">Go</a></li>
<li><a href="https://github.com/atom/language-html">HTML</a></li>
<li><a href="https://github.com/atom/language-javascript">JavaScript</a></li>
<li><a href="https://github.com/atom/language-python">Python</a></li>
<li><a href="https://github.com/atom/language-ruby">Ruby</a></li>
<li><a href="https://github.com/atom/language-typescript">TypeScript</a></li>
</ul>
        </div>
      </div>
      <div class="footer-pad"></div>
    </div>
    <footer>
  <div class="footer">
    <div class="wrapper no-pad">
      <ul class="footer-left">
        <li><a href="https://atom.io/terms">Terms of Use</a></li>
        <li><a href="https://help.github.com/articles/github-privacy-policy/">Privacy</a></li>
        <li><a href="https://github.com/atom/atom/blob/master/CODE_OF_CONDUCT.md">Code of Conduct</a></li>
        <li><a href="https://atom.io/releases">Releases</a></li>
        <li><a href="https://atom.io/faq">FAQ</a></li>
        <li><a href="https://atom.io/contact">Contact</a></li>
        <li><a href="https://github.com/atom/flight-manual.atom.io/blob/master/CONTRIBUTING.md">Contribute!</a></li>
      </ul>

      <div class="footer-right">
        <a href="https://github.com"><span class="octicon octicon-code"></span> with <span class="octicon octicon-heart"></span> by <span class="octicon octicon-logo-github"></span></a>
      </div>
    </div>
  </div>
</footer>

  </body>
</html>
